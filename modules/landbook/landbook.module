<?php
/**
 * @file
 * This module provide an interface to the landbook section of the Landportal.
 *
 * The Landportal landbook
 *
 * Drupal refactoring: Jules <jules@ker.bz>
 */


$BOOK_PATH = drupal_get_path('module', 'landbook');

require_once($BOOK_PATH . '/includes/landbook.menu.inc');
require_once($BOOK_PATH . '/includes/landbook.block.inc');
require_once($BOOK_PATH . '/includes/landbook.theme.inc');
//require_once($BOOK_PATH . '/includes/landbook.library.inc');
require_once($BOOK_PATH . '/includes/landbook.views_default.inc');

function landbook_views_api($module = NULL, $api = NULL) {
  return array("api" => "3.0");
}

function landbook_help($path, $arg) {
  switch ($path) {
  case "admin/help#landbook":
    return '<p>' . t("Landbook section of the Landportal") . '</p>'
      . '<p>' . t("It provides differents menus, block, pages and hooks plus a few configuration pages"). '</p>'
      . '<p>' . t("The Landbook is composed of different modules: catalog, countries, indicators, regions, reuse, sources, widgets") . '</p>'
      . '<p>' . t("Each submodule comes with some JS to allow dynamic actions and template(s) for main content and eventually sidebars elements.") . '</p>'
      . '<p>' . t("This module also provides ajax ready pages (which output some JSON, see: ajax/) for JS callbacks.") . '</p>'
      ;
    break;
  }
}

// Hook country narrative page
function landbook_page_build(&$page) {
    $e = explode('/', $_GET['q']);
    if ($e[0] == 'book' && $e[1] == 'countries') {
        landbook_country_narrative($e[2]);
    }
}

function landbook_country_narrative($iso3) {
    global $LBVIS_PATH;
    $LBVIS_PATH = base_path() . 'sites/all/libraries/lbvis';
    // TODO: should be added by hook_library while declaring view-coda (aka lbvis)
    // TODO: add css with #attached (see vis_map module)
    drupal_add_css($LBVIS_PATH . '/css/screen.css', array('group' => CSS_DEFAULT));
    drupal_add_css($LBVIS_PATH . '/css/spinkit.css', array('group' => CSS_DEFAULT));
    drupal_add_js(array(
        'landbook' => array(
            //'path'          => $theme_path,
            'libraryPath'   => $LBVIS_PATH,
            'countryCode'   => $iso3
        )
    ), 'setting');
}

/**
 * Note: Webcoding
 * Explain AND document all the following functions
 * most of it seems overkill, un-necessary
 */
function landbook_views_query_alter(&$view, &$query){
    if(!empty($view->name) && $view->name=='landbook_countries_related'){
        if(arg(0)=='book' && arg(1) == 'countries'){
            $tid=landbook_get_region_iso(arg(2));
            $query->where[0]['conditions'][0]['value']=$tid;
        }
    }
}

function landbook_get_region_iso($iso){
    $tid = db_select('field_data_field_iso3', 't')
      ->fields('t', array('entity_id'))
      ->condition('t.field_iso3_value', $iso)
      ->condition('t.bundle', 'regions')
      ->execute()
      ->fetchField();
    return $tid;
}

function landbook_fill_regions_terms(){
    $terms=taxonomy_get_tree(3);
    foreach ($terms as $key => $term) {
        $tid = db_select('taxonomy_term_data', 't')
          ->fields('t', array('tid'))
          ->condition('t.name', $term->name)
          ->condition('t.vid', '7')
          ->execute()
          ->fetchField();
        $old_term=taxonomy_term_load($term->tid);
        $reg_term=taxonomy_term_load($tid);
        $reg_term->field_iso3['und'][0]['value']=$old_term->field_iso3['und'][0]['value'];
        try {
            taxonomy_term_save($reg_term);
        } catch(Exception $e) {
            error_log('LB fill regions terms');
        }
    }
}

function landbook_get_country_narrative_nid($title){
  $nid = db_select('node', 'n')
  ->fields('n', array('nid'))
  ->condition('n.title', $title)
  ->condition('n.type', 'landbook_country')
  ->execute()
  ->fetchField();
  return $nid;
}

function load_country_description($title){
  $nid = db_select('node', 'n')
  ->fields('n', array('nid'))
  ->condition('n.title', $title)
  ->condition('n.type', 'landbook_country')
  ->execute()
  ->fetchField();
  if(empty($nid)){
    return '';
  }
  else{
    $node = node_load($nid);
    $description=node_view($node, 'teaser'); 
    return $description ;
  }
}
