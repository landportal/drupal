<?php
use mikehaertl\wkhtmlto\Pdf;
/**
 * @file
 * This module provide an interface to the landbook section of the Landportal.
 *
 * The Landportal landbook
 *
 * Drupal refactoring: Jules <jules@ker.bz>
 */

$BOOK_PATH = drupal_get_path('module', 'landbook');
require_once($BOOK_PATH . '/includes/landbook.block.inc');
require_once($BOOK_PATH . '/includes/landbook.context.inc');
require_once($BOOK_PATH . '/includes/landbook.menu.inc');
require_once($BOOK_PATH . '/includes/landbook.theme.inc');
require_once($BOOK_PATH . '/includes/landbook.views_default.inc');


/**
 * Implements hook_ctools_plugin_api().
 */
function landbook_ctools_plugin_api($module = NULL, $api = NULL) {
    if ($module == "context" && $api == "context") {
        return array("version" => "3");
    }
}

function landbook_views_api($module = NULL, $api = NULL) {
  return array("api" => "3.0");
}

function landbook_help($path, $arg) {
  switch ($path) {
  case "admin/help#landbook":
    return '<p>' . t("Landbook section of the Landportal") . '</p>'
      . '<p>' . t("It provides differents menus, block, pages and hooks plus a few configuration pages"). '</p>'
        . '<p>' . t("The Landbook is composed of different modules: catalog, countries, indicators, regions, reuse, sources, widgets") . '</p>';
    break;
  }
}

/**
 * Note: Webcoding
 * Explain AND document all the following functions
 * most of it seems overkill, un-necessary
 */
function landbook_views_query_alter(&$view, &$query){
  if(!empty($view->name) && $view->name=='landbook_countries_related'){
      if(arg(0)=='book' && arg(1) == 'countries'){
          if($view->current_display != 'block_6'){
            $tid=landbook_get_region_iso(arg(2));
            $query->where[0]['conditions'][0]['value'] = $tid;
          }
          // WTF is block6?
          else{
            $tid = landbook_get_country_iso(arg(2));
            // WTFWTF?
            $query->where[1]['conditions'][4]['value'] = $tid;
          }
      }
  }
  if(!empty($view->name) && $view->name=='landbook_thematics_related'){
    $args = arg();
    if($args[0] == 'node' && is_numeric($args[1])){
      $node = node_load($args[1]);
      if($node->type == 'thematic_narrative'){
        $field_values = field_get_items('node', $node, 'field_landvoc_to');
        $tid = $field_values[0]['target_id'];
        if($view->current_display != 'block_6'){
          $query->where[0]['conditions'][0]['value'] = $tid;
        }
        else{
          $query->where[1]['conditions'][4]['value'] = $args[1];
          $query->where[1]['conditions'][4]['operator'] = '=';

          $query->where[2]['conditions'][5]['value'] = $tid;
          $query->where[2]['conditions'][5]['operator'] = '=';

          $query->where[3]['conditions'][2]['value'] = $tid;
          $query->where[3]['conditions'][2]['operator'] = '=';
        }
      }
    }
  }
}
// TMP? 
function landbook_get_region_iso($iso){
    $tid = db_select('field_data_field_iso3', 't')
      ->fields('t', array('entity_id'))
      ->condition('t.field_iso3_value', $iso)
      ->condition('t.bundle', 'regions')
      ->execute()
      ->fetchField();
    return $tid;
}
// TMP?
function landbook_get_country_iso($iso){
    $tid = db_select('field_data_field_iso3', 't')
      ->fields('t', array('entity_id'))
      ->condition('t.field_iso3_value', $iso)
      ->condition('t.bundle', 'countries')
      ->execute()
      ->fetchField();
    return $tid;
}


/**
 * Implements hook_views_pre_render().
 */
// WFT is going on there?
function landbook_views_pre_render(&$view) {
  // We target the views and probably the display we want to customize.
    if (!empty($view->name) && $view->name === 'landbook_countries_related' && $view->current_display === 'block_5') {
      // Only act on when the views is set to use "more link".
      if ($view->display_handler->use_more()) {
        $args = arg();
        // Load the term. The argument can be passed by url or panel configuration.
        if (!empty($args[2])) {
          $query = db_select('taxonomy_term_data', 't');
          $query->fields('t', array('tid'));
          $query->leftJoin('field_data_field_iso3', 'fdfi', 'fdfi.entity_id = t.tid');
          $query->condition('fdfi.field_iso3_value', $args[2]);
          $query->condition('t.vid', '7');
          $tid = $query->execute()->fetchField();
          if ($tid) {
            // Set to use 'custom_url'.
            $view->display_handler->set_option('link_display', 'custom_url');
            // Change the link url.
            $view->display_handler->set_option('link_url', 'library/search');
            $view->exposed_raw_input['f[0]'] = 'im_field_geographical_focus:' . $tid;
          }
        }
      }
    }
}


// Implement country promoted stuff
// WTF?
// So this is both here and in land_util(ity?)?
function landbook_form_alter(&$form, &$form_state, $form_id){
  if($form_id == 'news_node_form'  || $form_id == 'blog_post_node_form' || $form_id == 'debate_node_form' || $form_id == 'event_node_form' || $form_id == 'landlibrary_resource_node_form' || $form_id == 'organization_node_form'){

    $form['#after_build'][] = 'landbook_form_custom_options_after_build';
    $form['options']['#attached']['js'][] = drupal_get_path('module', 'landbook') . '/js/landbook.js';

    if ($form_id != 'organization_node_form') {
      $terms = array('0'=>'--None--');
      $countries = taxonomy_get_tree(3);
      foreach ($countries as $country) {
        $terms[$country->tid]=$country->name;
      }

      $default = array();

      if (!empty($form['#node']->field_country_promoted[LANGUAGE_NONE])) {
        $default_values = $form['#node']->field_country_promoted[LANGUAGE_NONE];
        foreach ($default_values as $value) {
          $default[] = $value['tid'];
        }
      }

      $form['options']['promoted_nodes'] = array(
        '#type'=> 'select',
        '#weight'=> 1,
        '#options'=> $terms,
        '#multiple'=> TRUE,
        '#default_value'=> $default,
      );

      $form['field_country_promoted']['#access'] = FALSE;
    }

    $thematic_narrative_nodes = node_load_multiple(array(), array('type' => 'thematic_narrative'));
    $thematic_nodes = array('0'=>'--None--');
    if (!empty($thematic_narrative_nodes)) {
      foreach ($thematic_narrative_nodes as $node) {
        $thematic_nodes[$node->nid] = $node->title;
      }
    }

    $default_thematic_nodes = array();

    if (!empty($form['#node']->field_thematic_promoted[LANGUAGE_NONE])) {
      $default_values = $form['#node']->field_thematic_promoted[LANGUAGE_NONE];
      foreach ($default_values as $value) {
        $default_thematic_nodes[] = $value['target_id'];
      }
    }

    $form['options']['promoted_thematic_nodes'] = array(
      '#type'=> 'select',
      '#weight'=> 10,
      '#options'=> $thematic_nodes,
      '#multiple'=> TRUE,
      '#default_value'=> $default_thematic_nodes,
    );

    array_unshift($form['#submit'],'landbook_save_promoted_nodes');
    $form['field_thematic_promoted']['#access'] = FALSE;
  }
}
function landbook_save_promoted_nodes(&$form, &$form_state){
  if (isset($form_state['values']['field_country_promoted'])) {
    $form_state['values']['field_country_promoted']['und'] = array();
    foreach($form_state['values']['promoted_nodes'] as $value){
      $form_state['values']['field_country_promoted']['und'][]['tid'] = $value;
    }
  }
<<<<<<< HEAD

  $form_state['values']['field_thematic_promoted'][LANGUAGE_NONE] = array();
  foreach($form_state['values']['promoted_thematic_nodes'] as $value){
    $form_state['values']['field_thematic_promoted'][LANGUAGE_NONE][]['target_id'] = $value;
  }
}

function landbook_form_custom_options_after_build($form, &$form_state){
  $form['options']['promoted_to_thematic_page']['#weight'] = 5;

  return $form;
=======
}

function landbook_get_narrative(){
    if (arg(0) == 'book' && arg(1) == 'countries') {
        global $language;
        $tid=landbook_get_region_iso(arg(2));
        $term=taxonomy_term_load($tid);
        $node_id=landbook_get_country_narrative_nid($term->name);
        $image='';
        if(!empty($node_id)){
            $node=node_load($node_id);
            $items = field_get_items('node', $node, 'field_orgref');
            if(!empty($items)){
                $item = array_shift($items);
                if(isset($item['entity'])){
                    $items = field_get_items('node', $item['entity'], 'field_image');
                    $url=$items[0]['uri'];
                    $params = array(
                        'style_name' => 'medium',
                        'path' => $url,
                      );
                    $image=theme('image_style', $params);
                }
                else{
                    $image='';
                }
            }
        }
        return $image;
    }
}

function landbook_preprocess_page(&$variables){
    $image=landbook_get_narrative();
    $variables['print_logo_image']='';
    if(!empty($image)){
       $variables['print_logo_image']='<div class="print-organization"><p>'.t('Country page powered by').'</p>'.$image.'</div>';
    }
>>>>>>> print
}