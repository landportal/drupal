<?php
/**
 * This module provide blocks to display js-view-coda maps
 *
 */

function landbook_vis_map_block_info() {
    $blocks['region_map'] = array(
        'info'          => t('Landbook: Country page: Region map'),
        'status'        => TRUE,
        'region'        => 'content',
        'visibility'    => BLOCK_VISIBILITY_LISTED,
        'pages'         => "book/countries/*",
        'weight'        => -52
    );
    $blocks['compare_map'] = array(
        'info'          => t('Landbook: Country page: Compare map'),
        'status'        => TRUE,
        'region'        => 'content',
        'visibility'    => BLOCK_VISIBILITY_LISTED,
        'pages'         => "book/countries/*\nbook/indicators/*\nbook/thematic/*",
        'weight'        => 12
    );
    $blocks['world_map'] = array(
        'info'          => t('Landbook: Countries: World map'),
        'status'        => TRUE,
        'region'        => 'content',
        'visibility'    => BLOCK_VISIBILITY_LISTED,
        'pages'         => "book/countries",
        'weight'        => -52
  );
  return $blocks;
}

function landbook_vis_map_block_view($delta = '') {
  $module_path = drupal_get_path('module', 'landbook_vis_map');
  $jsAttr = 'vis: LBV, map_data: map_data'
    . ', iso3: (Drupal.settings.landbook.type == "country" ? Drupal.settings.landbook.countryCode : null)'
    . ', target: "#block-landbook-vis-map-' . str_replace('_', '-', $delta) . '"';
  $jsAttrInd = ', indicators: (Drupal.settings.landbook.type == "indicators" ? false : true)';
  $jsAttrInd .= ', indicator: (Drupal.settings.landbook.map ? Drupal.settings.landbook.map '
    . ' : (Drupal.settings.landbook.id ? Drupal.settings.landbook.id : "WB-SP.RUR.TOTL.ZS"))';

  $block = array();
  switch ($delta) {
  case 'region_map' :
    $jsAttr .= ', zoom: 2, height: 200';
    $block['subject'] = '';
    $block['content'] = array(
      '#attached' => array(
        'library' => array(array('landbook_view_coda', 'lbvis.map')),
        'js' =>  array(array(
          'type' => 'inline',
          'data' => landbook_view_coda_lbvis_ready_callback(
            'LBML = new lbvisMap({' . $jsAttr . '}); LBML.init();')
        ))
      )
    );
    break;
  case 'compare_map' :
    $jsAttr .= $jsAttrInd . ', title: true, subtitle: true, legend: true, tooltip: true, years: true';
    $block['subject'] = t('Mapping');
    $block['content'] = array(
      '#attached' => array(
        'library' => array(array('landbook_view_coda', 'lbvis.map')),
        'js' =>  array(array(
          'type' => 'inline',
          'data' => landbook_view_coda_lbvis_ready_callback(
            'LBMC = new lbvisMap({' . $jsAttr . '}); LBMC.init();')
        ))
      )
    );
    break;
  case 'world_map' :
    $jsAttr .= 'selectable: true, tooltip: function () { return "Click to visit " + this.point.name; }'
      . ', events: { click: function () { window.location.href = "/book/countries/" + this.id; } }';
    $block['subject'] = '';
    $block['content'] = array(
      '#attached' => array(
        'library' => array(array('landbook_view_coda', 'lbvis.map')),
        'js' =>  array(array(
          'type' => 'inline',
          'data' => landbook_view_coda_lbvis_ready_callback(
            'LBMW = new lbvisMap({' . $jsAttr . '}); LBMW.init();')
        ))
      )
    );
    break;
  }
  return $block;
}
