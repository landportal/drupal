<?php
/**
 * @file
 * Code for the CT Dataset feature.
 */

include_once 'ct_dataset.features.inc';

// Get the latest CT dataset
function ct_dataset__get_latest($tid) {
  $query = new EntityFieldQuery();
  $query->entityCondition('entity_type', 'node')
        ->fieldCondition('field_catalog', 'tid', $tid, '=')
        ->range(0, 1)
        ->propertyOrderBy('created', 'DESC');
  $result = $query->execute();
  if ($result) {
    $last = array_keys($result['node'])[0];
    return $last;
  }
}

function ct_dataset_entity_view_mode_alter(&$view_mode, $context) {
  if ($view_mode == 'full' && $context['entity_type'] == 'taxonomy_term') {
    $entity = $context['entity'] ;
    if ($entity->vocabulary_machine_name == 'datasets') {
      // Check if we have a DS node
      if ($dsid = ct_dataset__get_latest($entity->tid)) {
        $entity->dsid = $dsid;
        $view_mode = 'header';
        //dpm($entity, $dsid);
      }
    }
  }
}

// If we have a latest CT dataset, replace tax. dataset page with it
function ct_dataset_page_build(&$page) {
  if (@($term = $page['content']['system_main']['term_heading']['term']['#term'])) {
    if ($term->vocabulary_machine_name != 'datasets') return;
    if ($term->dsid) {
      //dpm($term, 'hello term p');
      $node = node_load($term->dsid);
      $page['dsid'] = $term->dsid;
      $page['content']['system_main']['nodes'] = array(
        $term->dsid => node_view($node, 'full') + array('#node' => $node)
      );
      unset($page['content']['system_main']['term_heading']);
    }
    //dpm($page, 'Pbuild');
  }
}

// dataset pages
function ct_dataset_preprocess(&$variables, $hook) {
  if ($hook != 'page' || !@$variables['page']['dsid']) return;
  $dsid = $variables['page']['dsid'];

  /* $variables['node'] = $variables['page']['node']; */
  /* $variables['classes_array'][] = 'page-node'; */
  /* $variables['classes_array'][] = 'node-type-' . $variables['page']['node']->type; */

  if (user_access('edit any dataset content') || user_access('administer nodes')) { //is_admin()) {
    $variables['tabs']['#primary'][] = array(
      '#markup' => '<li>' . l('Edit narrative', 'node/' . $dsid . '/edit') . '</li>',
    );
  }
}


