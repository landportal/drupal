<?php
/**
 * @file
 * Code for the Landportal Partners module
 */

include_once 'landportal_partners.features.inc';
include_once 'landportal_partners.block.inc';
include_once 'landportal_partners.context.inc';

function landportal_partners_views_api($module = NULL, $api = NULL) {
  return array("api" => "3.0");
}


// Show
// Add block descriptions to Partners header menu
function landportal_partners_preprocess_page(&$variables) {
  if ($variables['page']['header']) {
    $pheader = $variables['page']['header'];
    foreach (array('menu-partners-mlike', 'menu-legend') as $i) {
      if (isset($pheader['menu_'.$i]) && $pheader['menu_'.$i]) {
        $menu = menu_load($i);
        $desc = i18n_string_translate('menu:menu:'.$i.':description', $menu['description']);
        $pheader['menu_'.$i]['#block']->description = $desc;
      }
    }
  }
}



/**
 * Implements hook_views_default_views().
 */
function landportal_partners_views_default_views() {
    $export = array();

    $path = drupal_get_path('module', 'landportal_partners').'/views';
    $files = file_scan_directory($path, '/\.inc$/');
    foreach ($files as $filepath => $file) {
      include_once $filepath;
      $export[$view->name] = $view;
    }
    return $export;
}

function landportal_partners_views_post_render(&$view, &$output, &$cache) {
  if ( ! ($view->name == 'partners_content' && $view->current_display == 'related') ) return;
  $jsnew = "<script>(function($) { $(document).ready(function() {
  $('.view-id-partners_content.view-display-id-related article a[href]').attr({ target: '_blank' })
}); }(jQuery));</script>";
  $output .= $jsnew;
}

// Override CKeditor JS
function landportal_partners_ckeditor_settings_alter(&$settings, $context) {
  /* global $node, $page; */
  /* dpm($page); */
  $path = drupal_get_path('module', 'landportal_partners');
  drupal_add_js(array('landportal_partners' => array('path' => $path)), 'setting');

  $settings['stylesCombo_stylesSet'] = "default:/" . $path . "/ckeditor.styles.js";
  $settings['contentsCss'][] = "/" . drupal_get_path('theme', 'lpbs') . "/css/style.css";

  // We only add the settings to ckeditor wysiwyg profiles.
//  if ($context['profile']->editor == 'ckeditor') {
  //$settings['bodyClass'] = 'partners-page';
  /* dpm($context); */
  /* dpm($settings); */
}

// FROM http://cgit.drupalcode.org/sandbox-rudiedirkx-2454217
/**
 * Implements hook_field_widget_form_alter().
 */
function landportal_partners_pre_render_ckeditor_element($element) {
  if (!isset($element['#entity'])) {
    return $element;
  }
  $entity = $element['#entity'];
  //dpm($element, 'cke element');
  if (!isset($element['#attributes']['data-ckeditor-body-classes'])) {
    $element['#attributes']['data-ckeditor-body-classes'] = '';
  }
  if (isset($entity->og_group_ref)) {
    $element['#attributes']['data-ckeditor-body-classes'] .=
      ' og-context-node-' . $entity->og_group_ref[LANGUAGE_NONE][0]['target_id'];
  } else if (isset($entity->type) && $entity->type == 'partners') {
    $element['#attributes']['data-ckeditor-body-classes'] .= ' og-context-node-' . $entity->nid;
  /* } else { */
  /*   dpm($element); */
  }
  return $element;
}

/**
 * Implements hook_element_info_alter().
 */
function landportal_partners_element_info_alter(&$types) {
  // Used when using ckeditor module.
  if (isset($types['text_format']['#pre_render']) && is_array($types['text_format']['#pre_render'])) {
    if (in_array('ckeditor_pre_render_text_format', $types['text_format']['#pre_render'])) {

      $types['text_format']['#pre_render'][] = 'landportal_partners_pre_render_ckeditor_element';
      $types['text_format']['#attached']['js'][] = array(
        'data' => drupal_get_path('module', 'landportal_partners') . '/landportal_partners.ckeditor.js',
        'type' => 'file',
        'scope' => 'footer',
        'weight' => 30,
      );
    }
  }
}
