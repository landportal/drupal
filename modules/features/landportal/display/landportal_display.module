<?php
/**
 * @file
 * Code for the Landportal field display feature.
 */

include_once 'landportal_display.features.inc';

/******************************************
 *
 *    Hacks for drupal node/page title
 */

// Search for the taxonomy term rendering in a page
function lpbs__taxonomy_term_page($page) {
  if (
    !isset($page['content']) ||
    !isset($page['content']['system_main']) ||
    !isset($page['content']['system_main']['term_heading']) ||
    !isset($page['content']['system_main']['term_heading']['term'])
  ) {
    return FALSE;
  }
  else {
    return $page['content']['system_main']['term_heading']['term'];
  }
}

function landportal_display_preprocess_page(&$variables) {
  // Taxonomy
  if (arg(0) == 'taxonomy' && arg(1) == 'term' && is_numeric(arg(2))) {
    $term = lpbs__taxonomy_term_page($variables['page']);
    if (isset($term['name_field'])) {
      //dpm($variables['node'], "Got a title_field");
      $variables['title'] = '';
    }
  }
  else if (isset($variables['node']) && isset($variables['node']->title_field)) {
    $node = $variables['node'];
    $content = $variables['page']['content']['system_main']['nodes'][$node->nid];
    /* dpm($node, "node "); */
    $variables['page']['title_header'] = array(
      '#groups' => $content['#groups']['group_header']
    );
    unset($variables['page']['content']['system_main']['nodes'][$node->nid]['#groups']['group_header']);
    foreach ($content['#groups']['group_header']->children as $field) {
      $variables['page']['title_header'][$field] = $content[$field];
      unset($variables['page']['content']['system_main']['nodes'][$node->nid][$field]);
    }
    //dpm($content, 'page main node');
    //dpm($content['#groups']['group_header']);
    //unset($variables['page']['content']['system_main']['nodes'][$node->nid]['title_field']);
    $variables['title'] = render($variables['page']['title_header']);
    //dpm($variables['page']);
  }
  //dpm($variables, 'vars');
}



/******************************************
 *
 *    Hacks for select2 on forms
 */

/**********************
** Implementation of hook_entity_info_alter().
***********************/

function landportal_display_entity_info_alter(&$entity_info){
  $entity_info['node']['view modes']['listing'] = array(
    'label' => t('Listing'),
    'custom settings' => TRUE,
  );
}

function landportal_display_form_alter(&$form, &$form_state, $form_id) {
  $fields = array(
    // LL specific
    'field_doc_type',
    'field_doc_publisher',
    'field_doc_provider',
    // LB specific
    'field_indicators',
    'field_indicator_ranking',
    'field_indicator_map',
    /* // Admin views */
    'type', // CT type? // for view admin
    'field_doc_type_tid',
    'field_doc_publisher_tid',
    'field_doc_provider_tid',
    // Commons
    'field_featured',
    'field_orgref',
    'field_geographical_focus',
    'field_related_topics',
    'field_related_domains',
    'field_related_themes'
  );
  $select = array();
  // Quickly scan form for fields
  foreach($fields as $field) {
    if (array_key_exists($field, $form)) {
      $select[] = $field;
    }
  }

    // Do we have any matches (ie select field that uses jquery.select) ?
  $forms = array(
    'field_ui_field_overview_form', 'user_profile_form', 'user_register_form',
    'apachesolr_search_custom_page_search_form', 'views_exposed_form',
    'taxonomy-form-term'
  );
  if (count($select) || in_array($form_id, $forms) || preg_match('/^views_ui_/', $form_id)) {
    // dpm($select, 'selected fields');
    global $theme;
    if ($theme != 'lpbs') {
      $form['#attached']['css'][] = drupal_get_path('module', 'landportal_display') . '/select2.css';
    }
    //$form['#attached']['js'][] = drupal_get_path('theme', 'lpbs') . '/js/select2.min.js';
    $form['#attached']['js'][] = drupal_get_path('module', 'landportal_display') . '/select2.min.js';
    $form['#attached']['js'][] = drupal_get_path('module', 'landportal_display') . '/select.js';
  }
}
